<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>7&nbsp; Case 1: Decision Making – Data-Driven Decision-Making</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./case4.html" rel="next">
<link href="./reporting.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-137c985508dec40e6d94f851f5c8fa1e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d1895762165437aad1b77e24d4ac7eb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./case1.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Case 1: Decision Making</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Data-Driven Decision-Making</a> 
        <div class="sidebar-tools-main">
    <a href="./Data-Driven-Decision-Making.docx" title="Download Docx" class="quarto-navigation-tool px-1" aria-label="Download Docx"><i class="bi bi-file-word"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./decision-making.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Decision-Making Basics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datapatterns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Identifying Data Patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Diagnostic Analytics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Predictive Analytics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Reporting Design</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./case1.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Case 1: Decision Making</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./case4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Case 4: Predictive Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#why-r" id="toc-why-r" class="nav-link active" data-scroll-target="#why-r"><span class="header-section-number">7.1</span> Why R?</a></li>
  <li><a href="#r-basics" id="toc-r-basics" class="nav-link" data-scroll-target="#r-basics"><span class="header-section-number">7.2</span> R Basics</a>
  <ul class="collapse">
  <li><a href="#basic-r-components." id="toc-basic-r-components." class="nav-link" data-scroll-target="#basic-r-components."><span class="header-section-number">7.2.1</span> Basic R components.</a></li>
  <li><a href="#working-with-tables-and-the-grammar-of-data-manipulation" id="toc-working-with-tables-and-the-grammar-of-data-manipulation" class="nav-link" data-scroll-target="#working-with-tables-and-the-grammar-of-data-manipulation"><span class="header-section-number">7.2.2</span> Working with tables and the grammar of data manipulation</a></li>
  </ul></li>
  <li><a href="#planning-a-festival" id="toc-planning-a-festival" class="nav-link" data-scroll-target="#planning-a-festival"><span class="header-section-number">7.3</span> Planning a festival</a>
  <ul class="collapse">
  <li><a href="#case-description" id="toc-case-description" class="nav-link" data-scroll-target="#case-description"><span class="header-section-number">7.3.1</span> Case description</a></li>
  <li><a href="#identifying-the-problem-and-decision-criteria" id="toc-identifying-the-problem-and-decision-criteria" class="nav-link" data-scroll-target="#identifying-the-problem-and-decision-criteria"><span class="header-section-number">7.3.2</span> Identifying the problem and decision criteria</a></li>
  <li><a href="#developing-a-plan-and-alternatives" id="toc-developing-a-plan-and-alternatives" class="nav-link" data-scroll-target="#developing-a-plan-and-alternatives"><span class="header-section-number">7.3.3</span> Developing a plan and alternatives</a></li>
  <li><a href="#finding-the-location" id="toc-finding-the-location" class="nav-link" data-scroll-target="#finding-the-location"><span class="header-section-number">7.3.4</span> Finding the location</a></li>
  <li><a href="#finding-the-line-up" id="toc-finding-the-line-up" class="nav-link" data-scroll-target="#finding-the-line-up"><span class="header-section-number">7.3.5</span> Finding the line-up</a></li>
  <li><a href="#wrapping-up" id="toc-wrapping-up" class="nav-link" data-scroll-target="#wrapping-up"><span class="header-section-number">7.3.6</span> Wrapping up</a></li>
  </ul></li>
  <li><a href="#merging-and-aggregating-data-in-excel" id="toc-merging-and-aggregating-data-in-excel" class="nav-link" data-scroll-target="#merging-and-aggregating-data-in-excel"><span class="header-section-number">7.4</span> Merging and aggregating data in Excel</a>
  <ul class="collapse">
  <li><a href="#make-use-of-the-table-feature" id="toc-make-use-of-the-table-feature" class="nav-link" data-scroll-target="#make-use-of-the-table-feature"><span class="header-section-number">7.4.1</span> Make use of the table feature</a></li>
  <li><a href="#pivot-tables-as-a-powerful-aggregation-feature" id="toc-pivot-tables-as-a-powerful-aggregation-feature" class="nav-link" data-scroll-target="#pivot-tables-as-a-powerful-aggregation-feature"><span class="header-section-number">7.4.2</span> Pivot tables as a powerful aggregation feature</a></li>
  <li><a href="#joining-data-in-excel" id="toc-joining-data-in-excel" class="nav-link" data-scroll-target="#joining-data-in-excel"><span class="header-section-number">7.4.3</span> Joining data in Excel</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-case1" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Case 1: Decision Making</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this chapter, we have two goals. First, we want to review the decision making process we introduced in <a href="decision-making.html" class="quarto-xref"><span>Chapter 2</span></a>.</p>
<div id="fig-dmdiag" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dmdiag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/P1/dmdiag.svg" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dmdiag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.1: A stylized rational decision process
</figcaption>
</figure>
</div>
<p>Second, we want to introduce basic R data manipulation steps using a simple decision problem that is to be solved with a data analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading additional 'packages'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdensity)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"hhs-ggtheme.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="why-r" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="why-r"><span class="header-section-number">7.1</span> Why R?</h2>
<p>Because it is easy:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a good life motto</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (sad <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(sad)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">be_awesome</span>()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># if you can read this, then you can R</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="r-basics" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="r-basics"><span class="header-section-number">7.2</span> R Basics</h2>
<section id="basic-r-components." class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="basic-r-components."><span class="header-section-number">7.2.1</span> Basic R components.</h3>
<p>Basically there are only two things: functions or objects (variables, data.frame, matrix, text, etc.).</p>
<p>Functions “do things”. So every time, you want to “do stuff”, you need a function. Objects are glorified value stores. A function is code that takes inputs and produces output. The simplest version is something like the add function. It takes two inputs and produces the sum as output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">+</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">35</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">23</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>)  <span class="co"># create some input (here, a vector object)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">mean</span>(x)  <span class="co"># do something with the input</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>y  <span class="co"># let's look at the output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.4</code></pre>
</div>
</div>
<p>As we said before an object is a glorified value store.The most widely used one is a vector. It stores values of the same <em>type</em>. You can easily build vectors using the c() function (for “concat”).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x_nums <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.3</span>, <span class="dv">200</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>x_mixed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="st">"test example"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>x_char <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"bw"</span>, <span class="st">"02"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>x_nums</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   1.0   0.3 200.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>x_mixed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2"            "test example"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>x_char</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a"  "bw" "02"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(x_mixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>As you can see x_mixed has converted all its element the type “character”. Vectors always contain the same type of elements. There are five basic types (Logical, integer, numeric, factor, and character. In addition, there are a few special ones like “date-time” types. These types are distinguished because of the difference in operations allowed on them. For example, Multiplying to integer numbers is a common operation. But what does ‘multiplying two sentences’ mean? Type distinctions thus help us (among other things) to check whether functions are executed with the right inputs.</p>
<p>An interesting case to highligh here are variables of type factor. Suppose you asked six people how they feel this morning and you get the responses</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mood <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"good"</span>, <span class="st">"great"</span>, <span class="st">"ok"</span>, <span class="st">"great"</span>, <span class="st">"don't ask"</span>), </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"don't ask"</span>, <span class="st">"ok"</span>, <span class="st">"good"</span>, <span class="st">"great"</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ordered =</span> <span class="cn">TRUE</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>mood</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] good      good      great     ok        great     don't ask
Levels: don't ask &lt; ok &lt; good &lt; great</code></pre>
</div>
</div>
<p>With factors we can define what is called categorical variables. Here we did so and also told R that there is an order to the possible responses. Now, we might want to ask: What is the average mood this morning? Let is throw the mean() function at the data and see what happens.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mood)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in mean.default(mood): argument is not numeric or logical: returning NA</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
</div>
<p>That obviously did not work, nor should it. Categorical variables do not have “distance” between the responses, even though they are ordered. We do not know whether the step from ‘ok’ to ‘good’ is as big as from ‘good’ to ‘great’. We could have also used integers to express the different responses and then computed a mean:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>mood_in_numbers <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(mood)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mood_in_numbers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 3 4 2 4 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mood_in_numbers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.833333</code></pre>
</div>
</div>
<p>Note, however that this is dangerous. Now we put an additional assumption in here. Namely that the steps between each category are equally long. Only then can we compute an average number. If we do not want to assume that, we should leave the variable as factor and then we are safe from accidentally doing operations that are not sensible for a categorical variable.</p>
<p>Often you want to store data of different types in one storage object (like a table in Excel). The go to object for that in R is a data.frame (or the tibble–for “tiny table” I think?–, which is a data.frame with less optionality. It is used in many tidyerse packages)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_example <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">SubjID =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>),</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Gender =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"male"</span>, <span class="st">"female"</span>, <span class="st">"female"</span>)),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Treat =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Hospital =</span> <span class="fu">c</span>(<span class="st">"Idaho"</span>, <span class="st">"Oklahoma"</span>, <span class="st">"Los Angeles"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>df_example</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">SubjID</th>
<th style="text-align: left;">Gender</th>
<th style="text-align: left;">Treat</th>
<th style="text-align: left;">Hospital</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">male</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Idaho</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">female</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">Oklahoma</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">female</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Los Angeles</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>data.frames are opinionated. As you can see, it turned the hospital column into a factor automatically. That is partly why some people prefer tibbles which don’t do that.</p>
</section>
<section id="working-with-tables-and-the-grammar-of-data-manipulation" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="working-with-tables-and-the-grammar-of-data-manipulation"><span class="header-section-number">7.2.2</span> Working with tables and the grammar of data manipulation</h3>
<p>R—and especially newer packages included in the tidyverse package ecosystem—have very expressive data verbs that make code readable. What people have realized is that most data manipulation steps that concerns data tables are really a combination of a few basic actions. The most common are listed below with their names as used in R’s <a href="https://dplyr.tidyverse.org/">dplyr</a> package:</p>
<div id="fig-dplyr" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dplyr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/dplyr_schema.png" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dplyr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.2: The basic grammar of data manipulation. Image <a href="http://perso.ens-lyon.fr/lise.vaudor/dplyr/">source</a>
</figcaption>
</figure>
</div>
<ul>
<li><code>select()</code> picks columns of a table based on their names.</li>
<li><code>filter()</code> picks rows of a table based on their values.</li>
<li><code>arrange()</code> changes the ordering of the rows.</li>
<li><code>mutate()</code> adds new columns that are functions of existing columns</li>
<li><code>summarise()</code> reduces/aggregates multiple rows down to a single summary.</li>
</ul>
<p>If you add <code>join</code> and <code>grouping</code> actions to this list, then 98% of everything you want to do is a combination of the above actions.</p>
<p>Let’s work on actual data though. We’ll use the palmer penguins data set for the basic introduction, because penguins are awesome. This is how the data looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(penguins)  <span class="co"># head() shows the first 6 rows of a table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 15%">
<col style="width: 20%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: left;">island</th>
<th style="text-align: right;">bill_length_mm</th>
<th style="text-align: right;">bill_depth_mm</th>
<th style="text-align: right;">flipper_length_mm</th>
<th style="text-align: right;">body_mass_g</th>
<th style="text-align: left;">sex</th>
<th style="text-align: right;">year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Adelie</td>
<td style="text-align: left;">Torgersen</td>
<td style="text-align: right;">39.1</td>
<td style="text-align: right;">18.7</td>
<td style="text-align: right;">181</td>
<td style="text-align: right;">3750</td>
<td style="text-align: left;">male</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="even">
<td style="text-align: left;">Adelie</td>
<td style="text-align: left;">Torgersen</td>
<td style="text-align: right;">39.5</td>
<td style="text-align: right;">17.4</td>
<td style="text-align: right;">186</td>
<td style="text-align: right;">3800</td>
<td style="text-align: left;">female</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Adelie</td>
<td style="text-align: left;">Torgersen</td>
<td style="text-align: right;">40.3</td>
<td style="text-align: right;">18.0</td>
<td style="text-align: right;">195</td>
<td style="text-align: right;">3250</td>
<td style="text-align: left;">female</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="even">
<td style="text-align: left;">Adelie</td>
<td style="text-align: left;">Torgersen</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Adelie</td>
<td style="text-align: left;">Torgersen</td>
<td style="text-align: right;">36.7</td>
<td style="text-align: right;">19.3</td>
<td style="text-align: right;">193</td>
<td style="text-align: right;">3450</td>
<td style="text-align: left;">female</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="even">
<td style="text-align: left;">Adelie</td>
<td style="text-align: left;">Torgersen</td>
<td style="text-align: right;">39.3</td>
<td style="text-align: right;">20.6</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">3650</td>
<td style="text-align: left;">male</td>
<td style="text-align: right;">2007</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(penguins)  <span class="co"># helpful function to give you a quick description of any R object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [344 × 8] (S3: tbl_df/tbl/data.frame)
 $ species          : Factor w/ 3 levels "Adelie","Chinstrap",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ island           : Factor w/ 3 levels "Biscoe","Dream",..: 3 3 3 3 3 3 3 3 3 3 ...
 $ bill_length_mm   : num [1:344] 39.1 39.5 40.3 NA 36.7 39.3 38.9 39.2 34.1 42 ...
 $ bill_depth_mm    : num [1:344] 18.7 17.4 18 NA 19.3 20.6 17.8 19.6 18.1 20.2 ...
 $ flipper_length_mm: int [1:344] 181 186 195 NA 193 190 181 195 193 190 ...
 $ body_mass_g      : int [1:344] 3750 3800 3250 NA 3450 3650 3625 4675 3475 4250 ...
 $ sex              : Factor w/ 2 levels "female","male": 2 1 1 NA 1 2 1 2 NA NA ...
 $ year             : int [1:344] 2007 2007 2007 2007 2007 2007 2007 2007 2007 2007 ...</code></pre>
</div>
</div>
<p>Back to data verbs and combing different verbs to arrive at any data manipulation you want. For example, <em>counting</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(species, <span class="at">name =</span> <span class="st">"n_penguins"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: right;">n_penguins</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Adelie</td>
<td style="text-align: right;">152</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chinstrap</td>
<td style="text-align: right;">68</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Gentoo</td>
<td style="text-align: right;">124</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Under the hood, the count() function does something like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n_penguins =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: right;">n_penguins</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Adelie</td>
<td style="text-align: right;">152</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chinstrap</td>
<td style="text-align: right;">68</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Gentoo</td>
<td style="text-align: right;">124</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In newer versions of dplyr, this more succinct version also works</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n_penguins =</span> <span class="fu">n</span>(), <span class="at">.by =</span> species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: right;">n_penguins</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Adelie</td>
<td style="text-align: right;">152</td>
</tr>
<tr class="even">
<td style="text-align: left;">Gentoo</td>
<td style="text-align: right;">124</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Chinstrap</td>
<td style="text-align: right;">68</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Once you understand these basic steps, you can translate them into any other language. They might use different verbs, but the steps are the same. For example, in SQL, the most common database query language, you would write the above as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a># SQL code, <span class="kw">not</span> R</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    species, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> n_penguins </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> penguins </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">GROUP</span> <span class="kw">BY</span> species;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>A note on pipes ( |&gt; or %&gt;% ):</strong></p>
<p>In our code you see a lot of |&gt; (or %&gt;%). Both mean: “Take whatever is left of |&gt; and put it as a first argument in what is right of |&gt;”. We think it makes for much more readable, chunked code.</p>
<pre><code>function1(function2(function3(data)))</code></pre>
<p>becomes</p>
<pre><code>data |&gt; 
  function3() |&gt; 
  function2() |&gt; 
  function1()</code></pre>
<p>which, to me, shows the order of execution and the separate steps in a more obvious fashion.</p>
<p>The rest of the common data manipulation steps we will illustrate by example using the following case.</p>
</section>
</section>
<section id="planning-a-festival" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="planning-a-festival"><span class="header-section-number">7.3</span> Planning a festival</h2>
<section id="case-description" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="case-description"><span class="header-section-number">7.3.1</span> Case description</h3>
<p>The following case uses the well-known Chinook sql <a href="https://www.sqlitetutorial.net/sqlite-sample-database/">database</a>. It is inspired by an exercise of an <a href="https://www.udacity.com/course/business-analytics-nanodegree--nd098">Udacity</a> course, which we modified and expanded to train and illustrate the decision-making process more clearly. Here is the case:</p>
<p>You work for Chinook, an internet music store. Your boss has the idea to organize a promo music festival and asks you to come with a good location and line-up.</p>
</section>
<section id="identifying-the-problem-and-decision-criteria" class="level3" data-number="7.3.2">
<h3 data-number="7.3.2" class="anchored" data-anchor-id="identifying-the-problem-and-decision-criteria"><span class="header-section-number">7.3.2</span> Identifying the problem and decision criteria</h3>
<p>The first step is always to clarify and clearly identify what the goal is. As we discussed before, a series of questions is usually helpful. What is the purpose of the festival: promotion. Of what? The music store. For what purpose? For the purpose of generating more revenues? Probably. So let us assume that is the goal. Organizing a festival with the goal of helping to generate future revenues.</p>
<p>The next step is the think about what criteria such as festival should fulfill.</p>
<ul>
<li>Location should enable us to promote our store and generate revenues</li>
<li>Budget? Not specified. Can we decide on the location without? Maybe, not ideal, but at least for a first best scenario, we can do without.</li>
<li>Same for artists. Artist choice would probably very much depend on budget. Takeaway: all we do here is a perfect world festival with unlimited budget.</li>
</ul>
</section>
<section id="developing-a-plan-and-alternatives" class="level3" data-number="7.3.3">
<h3 data-number="7.3.3" class="anchored" data-anchor-id="developing-a-plan-and-alternatives"><span class="header-section-number">7.3.3</span> Developing a plan and alternatives</h3>
<p>We have a goal (organizing a festival, which promotes the store and generates new revenues) and decided to not impose further restrictions for now. Location and line-up are obviously important parameters here. How should they be chosen? A few thoughts:</p>
<ul>
<li>To maximize promotional effect, we ideally want to put the festival somewhere where we can reach many customers. So put it where most existing customers are or none?
<ul>
<li>We probably want an area with a lot of existing customers (we can target them and they are more likely to come). We need to make sure the festival is not empty. Empty festivals are negative promotion! But we also want potential new customers to come and give them a favorable impression of the store.</li>
<li>So, what is a good location? Where there are lots of existing customers + many potential new customers</li>
<li>Should we focus on high revenue customers? Or would any customer do?</li>
</ul></li>
<li>What is a good line-up?
<ul>
<li>You probably have something like 10 hours of show potential (12:00 to 22:00). 4 * 1 + 4* 1.5 is 10 hours meaning 8 artist slots.</li>
<li>Do we want the most popular artists only? Probably not. We need some popular artists in order to draw a crowd. But those are expensive. And people own their songs already. If possible, we should also have promising, young artists or popular ones with new albums in there. Those will, if well-received, be bought and generate revenues.</li>
<li>What is a good mix? Very much depends on budget, which we do not know. Qualify, but for now, half and half is probably a good default.</li>
</ul></li>
</ul>
</section>
<section id="finding-the-location" class="level3" data-number="7.3.4">
<h3 data-number="7.3.4" class="anchored" data-anchor-id="finding-the-location"><span class="header-section-number">7.3.4</span> Finding the location</h3>
<p>Now that we have a plan, let’s look at the data and see whether we can execute on it. The following code loads the tidyverse package and a package to access an sqllite database. Then it connects to the chinook database and lists the tables inside the database.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSQLite)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>conn <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(<span class="fu">SQLite</span>(), <span class="st">"analysisgen/chinook.db"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>conn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQLiteConnection&gt;
  Path: /Users/judith/Library/CloudStorage/Dropbox/324070-M-6-3DM/DDDMbook/analysisgen/chinook.db
  Extensions: TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(conn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "albums"          "artists"         "customers"       "employees"      
 [5] "genres"          "invoice_items"   "invoices"        "media_types"    
 [9] "playlist_track"  "playlists"       "sqlite_sequence" "sqlite_stat1"   
[13] "tracks"         </code></pre>
</div>
</div>
<p>You can view the database diagram <a href="https://www.sqlitetutorial.net/sqlite-sample-database/">here</a>. In order to figure out where our customers are concentrated, we need to find data about which cities or regions they are from. Looking at the diagram, this data is most likely stored in the <code>invoices</code> table. Let’s have a look:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(conn, <span class="st">"invoices"</span>) <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: ??
Columns: 9
Database: sqlite 3.47.1 [/Users/judith/Library/CloudStorage/Dropbox/324070-M-6-3DM/DDDMbook/analysisgen/chinook.db]
$ InvoiceId         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 1…
$ CustomerId        &lt;int&gt; 2, 4, 8, 14, 23, 37, 38, 40, 42, 46, 52, 2, 16, 17, …
$ InvoiceDate       &lt;chr&gt; "2009-01-01 00:00:00", "2009-01-02 00:00:00", "2009-…
$ BillingAddress    &lt;chr&gt; "Theodor-Heuss-Straße 34", "Ullevålsveien 14", "Grét…
$ BillingCity       &lt;chr&gt; "Stuttgart", "Oslo", "Brussels", "Edmonton", "Boston…
$ BillingState      &lt;chr&gt; NA, NA, NA, "AB", "MA", NA, NA, NA, NA, "Dublin", NA…
$ BillingCountry    &lt;chr&gt; "Germany", "Norway", "Belgium", "Canada", "USA", "Ge…
$ BillingPostalCode &lt;chr&gt; "70174", "0171", "1000", "T6G 2C7", "2113", "60316",…
$ Total             &lt;dbl&gt; 1.98, 3.96, 5.94, 8.91, 13.86, 0.99, 1.98, 1.98, 3.9…</code></pre>
</div>
</div>
<p>‘BillingCity’ looks like a variable we could use to decide on the location of our festival. Let us compute how much revenues we do by city. For that we need to group all the invoices by city and sum up the revenues (the ‘Total’ column). This is an aggregation operation. A standard data manipulation. Group then compute a summary measure. The dplyr package offers the summarise function to do just that. We need to call the <code>collect()</code> function in the end, because everything in code lines 2-7 is done inside the database. Line 8 then pulls the data from the database into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>rev_by_city <span class="ot">&lt;-</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(conn, <span class="st">"invoices"</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_billings =</span> <span class="fu">sum</span>(Total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(BillingCity, BillingCountry)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>total_billings) <span class="sc">|&gt;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rev_by_city)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">BillingCity</th>
<th style="text-align: left;">BillingCountry</th>
<th style="text-align: right;">total_billings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Prague</td>
<td style="text-align: left;">Czech Republic</td>
<td style="text-align: right;">90.24</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mountain View</td>
<td style="text-align: left;">USA</td>
<td style="text-align: right;">77.24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Paris</td>
<td style="text-align: left;">France</td>
<td style="text-align: right;">77.24</td>
</tr>
<tr class="even">
<td style="text-align: left;">Berlin</td>
<td style="text-align: left;">Germany</td>
<td style="text-align: right;">75.24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">London</td>
<td style="text-align: left;">United Kingdom</td>
<td style="text-align: right;">75.24</td>
</tr>
<tr class="even">
<td style="text-align: left;">São Paulo</td>
<td style="text-align: left;">Brazil</td>
<td style="text-align: right;">75.24</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>As an aside, since dplyr operates on a table connection in this specific case, it actually transforms the dplyr code into SQL code and sends that code to the SQL database. We can see that code by calling <code>show_query()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(conn, <span class="st">"invoices"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">total_billings =</span> <span class="fu">sum</span>(Total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.by =</span> BillingCity</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(<span class="sc">-</span>total_billings) <span class="sc">|&gt;</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT `BillingCity`, SUM(`Total`) AS `total_billings`
FROM `invoices`
GROUP BY `BillingCity`
ORDER BY -`total_billings`</code></pre>
</div>
</div>
<p>Not terribly important to know, it just shows the flexibility of dplyr to work on many different data sources. Plus it shows the similarity to other programming languages.</p>
<p>Back to the problem. Here is our result again in figure form.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>rev_by_city <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">fct_reorder</span>(BillingCity, total_billings), </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> total_billings)) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="case1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Or if you would put this into a presentation later, add an action title and make it pretty with a few more lines:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>rev_by_city <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">fct_reorder</span>(BillingCity, total_billings), </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> total_billings)) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"darkorchid"</span>)<span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_line</span>()) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="fl">0.01</span>)) <span class="sc">+</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Locate the festival in Eastern Europe"</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison of total revenues by customer location"</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"source: company internal data"</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"City"</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Total revenues ($)"</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="case1_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>But let’s stop here. Is Prague really where we want to put our festival? Is it the most densely populated city for example? Given our discussion above, we probably want to take density into account to also attract as many new customers as possible. (Again, we are ignoring costs …). After a bit of googling, you find city data here at <a href="https://simplemaps.com/data/world-cities">simplemaps</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>world_cities <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"analysisgen/worldcities.xlsx"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>world_cities <span class="ot">&lt;-</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  world_cities <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> <span class="fu">case_when</span>(</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>      country <span class="sc">==</span> <span class="st">"United States"</span> <span class="sc">~</span> <span class="st">"USA"</span>, </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>      country <span class="sc">==</span> <span class="st">"Czechia"</span> <span class="sc">~</span> <span class="st">"Czech Republic"</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> country)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(world_cities)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">city</th>
<th style="text-align: left;">city_ascii</th>
<th style="text-align: right;">lat</th>
<th style="text-align: right;">lng</th>
<th style="text-align: left;">country</th>
<th style="text-align: left;">iso2</th>
<th style="text-align: left;">iso3</th>
<th style="text-align: left;">admin_name</th>
<th style="text-align: left;">capital</th>
<th style="text-align: right;">population</th>
<th style="text-align: right;">id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Tokyo</td>
<td style="text-align: left;">Tokyo</td>
<td style="text-align: right;">35.6897</td>
<td style="text-align: right;">139.6922</td>
<td style="text-align: left;">Japan</td>
<td style="text-align: left;">JP</td>
<td style="text-align: left;">JPN</td>
<td style="text-align: left;">Tōkyō</td>
<td style="text-align: left;">primary</td>
<td style="text-align: right;">37732000</td>
<td style="text-align: right;">1392685764</td>
</tr>
<tr class="even">
<td style="text-align: left;">Jakarta</td>
<td style="text-align: left;">Jakarta</td>
<td style="text-align: right;">-6.1750</td>
<td style="text-align: right;">106.8275</td>
<td style="text-align: left;">Indonesia</td>
<td style="text-align: left;">ID</td>
<td style="text-align: left;">IDN</td>
<td style="text-align: left;">Jakarta</td>
<td style="text-align: left;">primary</td>
<td style="text-align: right;">33756000</td>
<td style="text-align: right;">1360771077</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Delhi</td>
<td style="text-align: left;">Delhi</td>
<td style="text-align: right;">28.6100</td>
<td style="text-align: right;">77.2300</td>
<td style="text-align: left;">India</td>
<td style="text-align: left;">IN</td>
<td style="text-align: left;">IND</td>
<td style="text-align: left;">Delhi</td>
<td style="text-align: left;">admin</td>
<td style="text-align: right;">32226000</td>
<td style="text-align: right;">1356872604</td>
</tr>
<tr class="even">
<td style="text-align: left;">Guangzhou</td>
<td style="text-align: left;">Guangzhou</td>
<td style="text-align: right;">23.1300</td>
<td style="text-align: right;">113.2600</td>
<td style="text-align: left;">China</td>
<td style="text-align: left;">CN</td>
<td style="text-align: left;">CHN</td>
<td style="text-align: left;">Guangdong</td>
<td style="text-align: left;">admin</td>
<td style="text-align: right;">26940000</td>
<td style="text-align: right;">1156237133</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mumbai</td>
<td style="text-align: left;">Mumbai</td>
<td style="text-align: right;">19.0761</td>
<td style="text-align: right;">72.8775</td>
<td style="text-align: left;">India</td>
<td style="text-align: left;">IN</td>
<td style="text-align: left;">IND</td>
<td style="text-align: left;">Mahārāshtra</td>
<td style="text-align: left;">admin</td>
<td style="text-align: right;">24973000</td>
<td style="text-align: right;">1356226629</td>
</tr>
<tr class="even">
<td style="text-align: left;">Manila</td>
<td style="text-align: left;">Manila</td>
<td style="text-align: right;">14.5958</td>
<td style="text-align: right;">120.9772</td>
<td style="text-align: left;">Philippines</td>
<td style="text-align: left;">PH</td>
<td style="text-align: left;">PHL</td>
<td style="text-align: left;">Manila</td>
<td style="text-align: left;">primary</td>
<td style="text-align: right;">24922000</td>
<td style="text-align: right;">1608618140</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We need to clean this one up a bit</p>
<p>Let’s merge this to our city data and compare</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>city_data <span class="ot">&lt;-</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  rev_by_city <span class="sc">|&gt;</span> </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    world_cities <span class="sc">|&gt;</span> <span class="fu">select</span>(city, country, population),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(BillingCity <span class="sc">==</span> city, BillingCountry <span class="sc">==</span> country)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(city_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">BillingCity</th>
<th style="text-align: left;">BillingCountry</th>
<th style="text-align: right;">total_billings</th>
<th style="text-align: right;">population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Prague</td>
<td style="text-align: left;">Czech Republic</td>
<td style="text-align: right;">90.24</td>
<td style="text-align: right;">1335084</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mountain View</td>
<td style="text-align: left;">USA</td>
<td style="text-align: right;">77.24</td>
<td style="text-align: right;">82409</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Paris</td>
<td style="text-align: left;">France</td>
<td style="text-align: right;">77.24</td>
<td style="text-align: right;">11060000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Berlin</td>
<td style="text-align: left;">Germany</td>
<td style="text-align: right;">75.24</td>
<td style="text-align: right;">4473101</td>
</tr>
<tr class="odd">
<td style="text-align: left;">London</td>
<td style="text-align: left;">United Kingdom</td>
<td style="text-align: right;">75.24</td>
<td style="text-align: right;">11262000</td>
</tr>
<tr class="even">
<td style="text-align: left;">São Paulo</td>
<td style="text-align: left;">Brazil</td>
<td style="text-align: right;">75.24</td>
<td style="text-align: right;">23086000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Now, how do we trade off our customer base in a location and the population there?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>city_data <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>population) <span class="sc">|&gt;</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">BillingCity</th>
<th style="text-align: left;">BillingCountry</th>
<th style="text-align: right;">total_billings</th>
<th style="text-align: right;">population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Delhi</td>
<td style="text-align: left;">India</td>
<td style="text-align: right;">38.62</td>
<td style="text-align: right;">32226000</td>
</tr>
<tr class="even">
<td style="text-align: left;">São Paulo</td>
<td style="text-align: left;">Brazil</td>
<td style="text-align: right;">75.24</td>
<td style="text-align: right;">23086000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">New York</td>
<td style="text-align: left;">USA</td>
<td style="text-align: right;">37.62</td>
<td style="text-align: right;">18972871</td>
</tr>
<tr class="even">
<td style="text-align: left;">Buenos Aires</td>
<td style="text-align: left;">Argentina</td>
<td style="text-align: right;">37.62</td>
<td style="text-align: right;">16710000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Bangalore</td>
<td style="text-align: left;">India</td>
<td style="text-align: right;">36.64</td>
<td style="text-align: right;">15386000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rio de Janeiro</td>
<td style="text-align: left;">Brazil</td>
<td style="text-align: right;">37.62</td>
<td style="text-align: right;">12592000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Just eye-balling, Sao Paulo seems a good candidate as it is the only one in the top 6 of both categories.</p>
</section>
<section id="finding-the-line-up" class="level3" data-number="7.3.5">
<h3 data-number="7.3.5" class="anchored" data-anchor-id="finding-the-line-up"><span class="header-section-number">7.3.5</span> Finding the line-up</h3>
<p>To decide on the four popular artists and the four up-and-coming bands we want in our line-up, we need to analyze our sales. Looking at the diagram, the data is dispersed across various tables. That is often the case to reduce the size of the database. What do we need now:</p>
<ul>
<li>We need to figure out which artists are popular in Sao Paulo</li>
<li>We need to figure out which music genres are popular in Sao Paulo</li>
<li>From the popular genres, we need to pick four artists</li>
</ul>
<p>Let’s look at some of the other tables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>invoice_items <span class="ot">&lt;-</span> <span class="fu">tbl</span>(conn, <span class="st">"invoice_items"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(invoice_items)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: ??
Columns: 5
Database: sqlite 3.47.1 [/Users/judith/Library/CloudStorage/Dropbox/324070-M-6-3DM/DDDMbook/analysisgen/chinook.db]
$ InvoiceLineId &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1…
$ InvoiceId     &lt;int&gt; 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4,…
$ TrackId       &lt;int&gt; 2, 4, 6, 8, 10, 12, 16, 20, 24, 28, 32, 36, 42, 48, 54, …
$ UnitPrice     &lt;dbl&gt; 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.…
$ Quantity      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>tracks <span class="ot">&lt;-</span> <span class="fu">tbl</span>(conn, <span class="st">"tracks"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(tracks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: ??
Columns: 9
Database: sqlite 3.47.1 [/Users/judith/Library/CloudStorage/Dropbox/324070-M-6-3DM/DDDMbook/analysisgen/chinook.db]
$ TrackId      &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17…
$ Name         &lt;chr&gt; "For Those About To Rock (We Salute You)", "Balls to the …
$ AlbumId      &lt;int&gt; 1, 2, 3, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 4, 4, 4, …
$ MediaTypeId  &lt;int&gt; 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ GenreId      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ Composer     &lt;chr&gt; "Angus Young, Malcolm Young, Brian Johnson", NA, "F. Balt…
$ Milliseconds &lt;int&gt; 343719, 342562, 230619, 252051, 375418, 205662, 233926, 2…
$ Bytes        &lt;int&gt; 11170334, 5510424, 3990994, 4331779, 6290521, 6713451, 76…
$ UnitPrice    &lt;dbl&gt; 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.99, 0.9…</code></pre>
</div>
</div>
<p>We need to merge the <code>TrackId</code> in <code>invoices_items</code>. We can match this to the invoices table via the <code>InvoiceId</code>. With the <code>TrackId</code> we can match the data in the tracks table to the invoices, which is what we are really after. First, we only need the São Paulo invoices and then we join <code>TrackId</code> from the <code>invoices_items</code> table to the data. The we join the <code>tracks</code> data using the <code>TrackId</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>bought_tracks <span class="ot">&lt;-</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(conn, <span class="st">"invoices"</span>) <span class="sc">|&gt;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BillingCity <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"São Paulo"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(invoice_items, <span class="fu">join_by</span>(InvoiceId <span class="sc">==</span> InvoiceId)) <span class="sc">|&gt;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(InvoiceId, TrackId) <span class="sc">|&gt;</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    tracks <span class="sc">|&gt;</span> <span class="fu">select</span>(TrackId, AlbumId, GenreId), </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(TrackId <span class="sc">==</span> TrackId))</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bought_tracks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">InvoiceId</th>
<th style="text-align: right;">TrackId</th>
<th style="text-align: right;">AlbumId</th>
<th style="text-align: right;">GenreId</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">738</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">744</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">750</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">756</td>
<td style="text-align: right;">59</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">762</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">768</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>With the <code>AlbumID</code> we can get the artist from the albums data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>genres <span class="ot">&lt;-</span> <span class="fu">tbl</span>(conn, <span class="st">"genres"</span>) <span class="sc">|&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Genre =</span> Name)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>artists <span class="ot">&lt;-</span> <span class="fu">tbl</span>(conn, <span class="st">"artists"</span>) <span class="sc">|&gt;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Artist =</span> Name)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>popular_tracks_data <span class="ot">&lt;-</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  bought_tracks <span class="sc">|&gt;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(<span class="fu">tbl</span>(conn, <span class="st">"albums"</span>), <span class="fu">join_by</span>(AlbumId <span class="sc">==</span> AlbumId)) <span class="sc">|&gt;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(genres, <span class="fu">join_by</span>(GenreId <span class="sc">==</span> GenreId)) <span class="sc">|&gt;</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(artists, <span class="fu">join_by</span>(ArtistId <span class="sc">==</span> ArtistId)) <span class="sc">|&gt;</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(popular_tracks_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 50%">
<col style="width: 7%">
<col style="width: 4%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">InvoiceId</th>
<th style="text-align: right;">TrackId</th>
<th style="text-align: right;">AlbumId</th>
<th style="text-align: right;">GenreId</th>
<th style="text-align: left;">Title</th>
<th style="text-align: right;">ArtistId</th>
<th style="text-align: left;">Genre</th>
<th style="text-align: left;">Artist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">738</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">7</td>
<td style="text-align: left;">Cássia Eller - Sem Limite [Disc 1]</td>
<td style="text-align: right;">77</td>
<td style="text-align: left;">Latin</td>
<td style="text-align: left;">Cássia Eller</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">744</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">7</td>
<td style="text-align: left;">Cássia Eller - Sem Limite [Disc 1]</td>
<td style="text-align: right;">77</td>
<td style="text-align: left;">Latin</td>
<td style="text-align: left;">Cássia Eller</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">750</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Come Taste The Band</td>
<td style="text-align: right;">58</td>
<td style="text-align: left;">Rock</td>
<td style="text-align: left;">Deep Purple</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">756</td>
<td style="text-align: right;">59</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Deep Purple In Rock</td>
<td style="text-align: right;">58</td>
<td style="text-align: left;">Rock</td>
<td style="text-align: left;">Deep Purple</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">762</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Fireball</td>
<td style="text-align: right;">58</td>
<td style="text-align: left;">Rock</td>
<td style="text-align: left;">Deep Purple</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">768</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Knocking at Your Back Door: The Best Of Deep Purple in the 80’s</td>
<td style="text-align: right;">58</td>
<td style="text-align: left;">Rock</td>
<td style="text-align: left;">Deep Purple</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>popular_artists <span class="ot">&lt;-</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  popular_tracks_data <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">nr_tracks_bought =</span> <span class="fu">n</span>(),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> Artist</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>nr_tracks_bought)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, what are the 4 most popular artists?</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(popular_artists, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Artist</th>
<th style="text-align: right;">nr_tracks_bought</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Pearl Jam</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">Deep Purple</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R.E.M.</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">U2</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Now let’s try to find the up-and-coming artists in the popular genres. First we need to figure out which these are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>popular_genres <span class="ot">&lt;-</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  popular_tracks_data <span class="sc">|&gt;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">nr_tracks_bought =</span> <span class="fu">n</span>(),</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Genre, GenreId)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>nr_tracks_bought)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(popular_genres)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Genre</th>
<th style="text-align: right;">GenreId</th>
<th style="text-align: right;">nr_tracks_bought</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Rock</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">40</td>
</tr>
<tr class="even">
<td style="text-align: left;">Latin</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Metal</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Alternative &amp; Punk</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Reggae</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hip Hop/Rap</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Looks like we want to focus on Rock and Latin. Now we need to think about how we can identify new but interesting Artists. What are the characteristics of such Artists?</p>
<ul>
<li>Not popular yet</li>
<li>Few, but recent Albums</li>
<li>Should show signs of recent popularity.</li>
</ul>
<p>Think about these characteristica for a second. Did you realize that these are essentially, filtering conditions? The first bullet point translates into: should not be in the upper part of our <code>popular_artists</code> data.frame. The second means, should have few but recently released Albums. Maybe we can filter for this using <code>InvoiceDate</code>. The third point we could translate as have most purchases in the last six months.</p>
<p>Once we have the relevant data collected from all tables, we only need to apply the correct filters that describe the characteristics above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>artists_tracks_link <span class="ot">&lt;-</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  tracks <span class="sc">|&gt;</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(GenreId <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TrackId, AlbumId) <span class="sc">|&gt;</span> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(<span class="fu">tbl</span>(conn, <span class="st">"albums"</span>), <span class="fu">join_by</span>(AlbumId <span class="sc">==</span> AlbumId)) <span class="sc">|&gt;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(artists, <span class="fu">join_by</span>(ArtistId <span class="sc">==</span> ArtistId)) <span class="sc">|&gt;</span> </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TrackId, Artist, ArtistId)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(artists_tracks_link)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">TrackId</th>
<th style="text-align: left;">Artist</th>
<th style="text-align: right;">ArtistId</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">AC/DC</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Accept</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Accept</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Accept</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Accept</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">AC/DC</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>young_artists <span class="ot">&lt;-</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(conn, <span class="st">"albums"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ArtistId) <span class="sc">|&gt;</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(young_artists)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">ArtistId</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>young_artist_invoices <span class="ot">&lt;-</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(conn, <span class="st">"invoices"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(InvoiceId, InvoiceDate) <span class="sc">|&gt;</span> </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(invoice_items, <span class="fu">join_by</span>(InvoiceId <span class="sc">==</span> InvoiceId)) <span class="sc">|&gt;</span> </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(artists_tracks_link, <span class="fu">join_by</span>(TrackId <span class="sc">==</span> TrackId)) <span class="sc">|&gt;</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(young_artists, <span class="fu">join_by</span>(ArtistId <span class="sc">==</span> ArtistId)) <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(InvoiceId, InvoiceDate, TrackId, Artist) <span class="sc">|&gt;</span> </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(young_artist_invoices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">InvoiceId</th>
<th style="text-align: left;">InvoiceDate</th>
<th style="text-align: right;">TrackId</th>
<th style="text-align: left;">Artist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">2009-01-03 00:00:00</td>
<td style="text-align: right;">24</td>
<td style="text-align: left;">Aerosmith</td>
</tr>
<tr class="even">
<td style="text-align: right;">109</td>
<td style="text-align: left;">2010-04-16 00:00:00</td>
<td style="text-align: right;">25</td>
<td style="text-align: left;">Aerosmith</td>
</tr>
<tr class="odd">
<td style="text-align: right;">214</td>
<td style="text-align: left;">2011-07-25 00:00:00</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">Aerosmith</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: left;">2009-01-03 00:00:00</td>
<td style="text-align: right;">28</td>
<td style="text-align: left;">Aerosmith</td>
</tr>
<tr class="odd">
<td style="text-align: right;">320</td>
<td style="text-align: left;">2012-11-06 00:00:00</td>
<td style="text-align: right;">30</td>
<td style="text-align: left;">Aerosmith</td>
</tr>
<tr class="even">
<td style="text-align: right;">109</td>
<td style="text-align: left;">2010-04-16 00:00:00</td>
<td style="text-align: right;">31</td>
<td style="text-align: left;">Aerosmith</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>young_artist_lineup <span class="ot">&lt;-</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  young_artist_invoices <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">InvoiceDate =</span> <span class="fu">ymd_hms</span>(InvoiceDate),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(InvoiceDate)) <span class="sc">|&gt;</span> </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter to only look at most recent purchases</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">max</span>(year)) <span class="sc">|&gt;</span> </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># counting purchases</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">nr_buys =</span> <span class="fu">n</span>(),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> Artist</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make sure to take out the top 6 popular artists:</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(Artist <span class="sc">%in%</span> <span class="fu">head</span>(popular_artists<span class="sc">$</span>Artist, <span class="dv">6</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now sort and show the top 4</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>nr_buys) <span class="sc">|&gt;</span> </span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">4</span>)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>young_artist_lineup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Artist</th>
<th style="text-align: right;">nr_buys</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">O Terço</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Men At Work</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">The Who</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Soundgarden</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="wrapping-up" class="level3" data-number="7.3.6">
<h3 data-number="7.3.6" class="anchored" data-anchor-id="wrapping-up"><span class="header-section-number">7.3.6</span> Wrapping up</h3>
<p>In summary:</p>
<ul>
<li>We decide to propose Sao Paulo as a location because it is the only city in the top six by number of existing customers and population to draw new customers from.</li>
<li>We propose 8 artists based on time constraints</li>
<li>We propose the top 4 artists based on what is popular with existing customers in the Sao Paulo:</li>
<li>We propose the top 4 newcomers (artists with only one album in our db) and most track purchases during the most recent year.</li>
</ul>
<p>We could think of other alternatives, but we stop here and evaluate the current one. It fits our criteria established above. The big issue is that we weren’t given any budget constraints. We could potentially also do a better job at identifying newcomers. Or we could also consider not only the city but define a radius of influence around a city when deciding on a location. We can still propose the current solution. We have solid arguments to justify our choices. But should keep these limitations in mind.</p>
</section>
</section>
<section id="merging-and-aggregating-data-in-excel" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="merging-and-aggregating-data-in-excel"><span class="header-section-number">7.4</span> Merging and aggregating data in Excel</h2>
<p>Everything we have done here, we can do in Excel, as long as the data we are dealing with is not too big. In this section we want to give a short intro into tables, queries, and pivot tables in excel. These tools have become quite powerful, so we showcase them here for comparison.</p>
<p>With the right tools, you can query SQL databases directly from excel too. To keep things simple, we put the tables in the chinook database into separate excel sheets in one file (see <a href="#fig-excel1" class="quarto-xref">Figure&nbsp;<span>7.3</span></a>.)</p>
<section id="make-use-of-the-table-feature" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="make-use-of-the-table-feature"><span class="header-section-number">7.4.1</span> Make use of the table feature</h3>
<p>The first thing we want to turn the data cells in these sheets into “tables” as these makes it easier to reference them later. Doing so is simple. Below we show how to do this for the invoices data sheet. Select any cell within the data range that constitutes your table (see <a href="#fig-excel1" class="quarto-xref">Figure&nbsp;<span>7.3</span></a>), then click on “Format as Table”. Pick a format, then make sure the cell range is correct and “has headers is checked”.</p>
<div id="fig-excel1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel1.png" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.3: Turn a cell range into a table
</figcaption>
</figure>
</div>
<p>Finally, we click on the Table Design section in the Excel ribbon and choose a name for the table (see <a href="#fig-excel2" class="quarto-xref">Figure&nbsp;<span>7.4</span></a>).</p>
<div id="fig-excel2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel2.png" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.4: Labeling tables
</figcaption>
</figure>
</div>
</section>
<section id="pivot-tables-as-a-powerful-aggregation-feature" class="level3" data-number="7.4.2">
<h3 data-number="7.4.2" class="anchored" data-anchor-id="pivot-tables-as-a-powerful-aggregation-feature"><span class="header-section-number">7.4.2</span> Pivot tables as a powerful aggregation feature</h3>
<p>Everything we have done so far with grouping and summarizing using the <code>summarise()</code> function in R can be done with the help of excel pivot tables to. Let us repeat the exercise of finding the city where most of Chinook’s revenues are originating from.</p>
<p>Click on the “Summarize with PivotTable” button you see in <a href="#fig-excel2" class="quarto-xref">Figure&nbsp;<span>7.4</span></a>. Choose to put the table into a new sheet. A new sheet will open and on the side you will see a Fields menu as shown in <a href="#fig-excel3" class="quarto-xref">Figure&nbsp;<span>7.5</span></a>. We want a similar output as we got from the <code>summarise()</code> function in R. We want the sum of the revenues grouped by billing city. So the rows of the output table should be billing cities. To get that, drag the BillingCity field into the Rows section (see <a href="#fig-excel3" class="quarto-xref">Figure&nbsp;<span>7.5</span></a>). The values in each row should be the sum of the “Total” field. So drag the “Total” field into the Values section. It usually defaults to “Sum of ..” which is what we want in this case. If it is not click on the down arrow, then on “Value Field Settings” in that menu, you can choose what aggregation is performed (sum, count, mean, min, max, etc.)</p>
<div id="fig-excel3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel3.png" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.5: Pivot table options
</figcaption>
</figure>
</div>
<p>We almost got what we want. We just need to sort the resulting pivot table from city with highest total revenues to lowest. For whatever reason, that sorting feature is a bit hidden. Right-click on any cell in the Sum of Total column and there you find a sort option (see <a href="#fig-excel4" class="quarto-xref">Figure&nbsp;<span>7.6</span></a>).</p>
<div id="fig-excel4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel4.png" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.6: Sorting pivot tables
</figcaption>
</figure>
</div>
<p>This is the result:</p>
<div id="fig-excel5" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel5.png" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.7: Most important cities
</figcaption>
</figure>
</div>
</section>
<section id="joining-data-in-excel" class="level3" data-number="7.4.3">
<h3 data-number="7.4.3" class="anchored" data-anchor-id="joining-data-in-excel"><span class="header-section-number">7.4.3</span> Joining data in Excel</h3>
<p>Joining data in Excel used to be a very error prone and cumbersome operation. It still is not as straightforward as with a programming language. But the current capabilities make it much much easier and clearer to debug. Here is one approach we like. We will illustrate merging using the question: “What are the genres of music that are bought by customers in Sao Paulo?” To figure this out, we need to merge three tables: invoices, invoice_items, and tracks. First we need to define a table for invoice_items and tracks—just as we did above for Invoices. Second, we need to create a query link for each table. This is because we will use power query to do the merging. Here is how we define a query for each table.</p>
<p>Click on a cell for the table we want to link, then go to the Data section and click on “From Table/Range” (see <a href="#fig-excel6" class="quarto-xref">Figure&nbsp;<span>7.8</span></a>)</p>
<div id="fig-excel6" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel6.png" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.8: Pivot table options
</figcaption>
</figure>
</div>
<p>This will open the power query editor. We are not going to do much there yet. Hit “close and load to”</p>
<div id="fig-excel7" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel7.png" height="150" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.9: Close and load to
</figcaption>
</figure>
</div>
<p>and then click “Only Create Connection”</p>
<div id="fig-excel8" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel8.png" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.10: Connections option
</figcaption>
</figure>
</div>
<p>Do this for all three tables we want to merge. You should then have three queries in your query sidebar:</p>
<div id="fig-excel9" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel9.png" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.11: Queries and Connections
</figcaption>
</figure>
</div>
<p>Now we are ready to do the merging. We have to do this in two steps because we want to do two merges. Click again on the Data section, then click the “Get Data” drop-down menu and choose “Combine Queries”.</p>
<div id="fig-excel10" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel10.png" height="350" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.12: Get data menu
</figcaption>
</figure>
</div>
<p>A menu will open where we can select two queries to join. We choose Invoices and InvoiceItems. Then we click on the columns in each table we want to join by (“InvoiceID”). Finally, we select “inner join” under “Join Kind”. Your selection should look like this (<a href="#fig-excel11" class="quarto-xref">Figure&nbsp;<span>7.13</span></a>):</p>
<div id="fig-excel11" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel11.png" height="400" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.13: Join menu
</figcaption>
</figure>
</div>
<p>Once you click “OK”, you will enter the power query editor again. It will show a new query called Merge1. Rename that to something like “SaoPauloTracks” by right-clicking on “Merge1” and choosing rename.</p>
<div id="fig-excel12" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel12.png" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.14: Name your queries so you know what they are for
</figcaption>
</figure>
</div>
<p>We called it SaoPaulo tracks, because we are going to filter this query a bit now too. Click on the dropdown arrow right next to the column “BillingCity” and select only Sao Paulo. Then click on the Icon right next to the column header InvoiceItems (see <a href="#fig-excel13" class="quarto-xref">Figure&nbsp;<span>7.15</span></a>.)</p>
<div id="fig-excel13" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel13.png" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.15: Including join columns
</figcaption>
</figure>
</div>
<p>This contains all the columns from the joint invoice_items table. When you click on it, it asks you what columns to keep. We only need “TrackId”. We also do not need a lot of the other columns still in this query. Click on Choose columns and get rid of all but InvoiceId, BillingCity, and TrackId. You final query should look like this and list the following steps on the right (see <a href="#fig-excel14" class="quarto-xref">Figure&nbsp;<span>7.16</span></a>.)</p>
<div id="fig-excel14" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel14.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.16: A finished joint query
</figcaption>
</figure>
</div>
<p>Click on “close and load to” again (see <a href="#fig-excel7" class="quarto-xref">Figure&nbsp;<span>7.9</span></a>) and again choose “Only Create Connection”. This is only an intermediate join that we do not want to output into our excel worksheets. We do need still merge the third table onto this. Now we are essentially repeat the join steps again, starting from “Get Data” and “Combine Queries” (<a href="#fig-excel10" class="quarto-xref">Figure&nbsp;<span>7.12</span></a>). This time we merge the SaoPauloTracks query and the Tracks query. And we join them by TracksId and choose “inner join” again.</p>
<div id="fig-excel15" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel15.png" height="400" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.17: Join menu again
</figcaption>
</figure>
</div>
<p>We click ok and click on expand right next to the header of the “Tracks” column and select only the GenreId and AlbumID columns. We rename the query to something like SaoPauloGenres. Now we again hit Close and load to. But this time we export to a new table and a new worksheet. The result should look like this (<a href="#fig-excel16" class="quarto-xref">Figure&nbsp;<span>7.18</span></a>):</p>
<div id="fig-excel16" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-excel16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pics/C1/excel16.png" height="400" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-excel16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.18: Final join output
</figcaption>
</figure>
</div>
<p>From here now we can produce produce a pivot table that produces the most popular genreIds and so on. We leave the rest of the case as an excercise.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./reporting.html" class="pagination-link" aria-label="Reporting Design">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Reporting Design</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./case4.html" class="pagination-link" aria-label="Case 4: Predictive Analysis">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Case 4: Predictive Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>